# AlgoLab WebSocket Bağlantı Kontrolü

## 🔍 IntelliJ Console'da Aranacak Loglar

Backend'i IDE'den başlattığınızda IntelliJ Console'da şu logları aramalısınız:

### ✅ Başarılı Bağlantı Logları

```
1. Startup Logları:
   - "AlgoLabWebSocketService initialized"
   - "WebSocket auto-connect successful"
   - "Loading saved AlgoLab session"

2. Bağlantı Logları:
   - "✅ WebSocket connected"
   - "Connected to AlgoLab WebSocket"
   - "WebSocket connection established"

3. Subscription Logları:
   - "✅ IMMEDIATE subscription sent"
   - "Subscription message sent for symbols: [USDTRY]"

4. Veri Alım Logları:
   - "✅ Received TICK data: Symbol=USDTRY"
   - "Processing tick for USDTRY"
   - "Message buffered: Type=T"
```

### ❌ Sorun Göstergeleri

```
- "WebSocket auto-connect failed"
- "No saved session found"
- "Connection closed with code: 1006"
- "Authentication failed"
- "Session expired"
```

---

## 🧪 Manuel Test Yöntemleri

### 1. Health Check
```bash
curl http://localhost:8080/actuator/health
# Sonuç: status "UP" olmalı
```

### 2. Session Kontrolü
```bash
cat algolab-session-dev.json | jq '.'
# Token ve hash olmalı
# lastUpdate son 24 saat içinde olmalı
```

### 3. Port Kontrolü
```bash
lsof -i :8080 | grep LISTEN
# Backend çalışıyor olmalı
```

### 4. CLI ile Test
```bash
cd cli-client
./start.sh
# Menu: 2 → 5 (Real-Time Tick Data)
# Symbol: USDTRY
# Eğer veri geliyorsa WebSocket çalışıyor demektir
```

---

## 📊 Config Durumu

### ✅ Mevcut Ayarlar (application-dev.yml)
```yaml
algolab:
  websocket:
    enabled: true
    url: wss://www.algolab.com.tr/api/ws
    auto-connect: true
    heartbeat-interval: 900000  # 15 dakika
```

### ✅ Session Dosyası
- **Konum:** `algolab-session-dev.json` (root dizin)
- **Durum:** ✅ Mevcut
- **Son Güncelleme:** 2025-10-17 16:23:30

---

## 🔄 WebSocket Bağlantısı Nasıl Çalışır?

1. **Startup (@PostConstruct)**
   - `AlgoLabWebSocketService` başlatılır
   - `algolab-session-dev.json` dosyası okunur
   - Eğer session varsa otomatik bağlantı başlar

2. **Bağlantı**
   - WebSocket client oluşturulur
   - Headers eklenir (APIKEY, Authorization, Checker)
   - `wss://www.algolab.com.tr/api/ws` adresine bağlanır

3. **Subscription**
   - Bağlantı kurulur kurulmaz subscription mesajı gönderilir
   - Varsayılan sembol: USDTRY
   - Format: `{"token": "...", "Type": "T", "Symbols": ["USDTRY"]}`

4. **Veri Akışı**
   - AlgoLab server tick data gönderir
   - Backend buffer'a ekler
   - HTTP API üzerinden erişilebilir hale gelir

---

## 🛠️ Sorun Giderme

### WebSocket Bağlanmıyorsa:

**1. Session Expired**
```bash
# CLI ile yeni login yap
cd cli-client
./start.sh
# Menu: 2 → 1 (AlgoLab Login)
```

**2. Config Hatası**
```bash
# application-dev.yml kontrol et
grep -A5 "websocket:" src/main/resources/application-dev.yml
```

**3. Port Çakışması**
```bash
# Backend portunu kontrol et
lsof -i :8080
# Eğer başka uygulama varsa kill et
```

**4. Manuel WebSocket Başlatma**
```bash
# Test endpoint ile
curl -X POST http://localhost:8080/api/test/websocket/connect-v2
```

---

## 📝 Log Seviyeleri

IntelliJ'de log seviyesini artırmak için:

1. **application-dev.yml** dosyasına ekle:
```yaml
logging:
  level:
    com.bisttrading.broker.algolab.websocket: DEBUG
    com.bisttrading.broker.algolab.service: DEBUG
```

2. **Restart** backend

3. Console'da detaylı logları gör

---

## ✅ Başarılı Bağlantı Örneği

IntelliJ Console'da şu sırayı görmelisiniz:

```
2025-10-17 16:00:00.123  INFO --- AlgoLabWebSocketService : AlgoLabWebSocketService initialized
2025-10-17 16:00:00.234  INFO --- AlgoLabAuthService      : Loading saved AlgoLab session from file
2025-10-17 16:00:00.345  INFO --- AlgoLabWebSocketService : Session loaded, attempting auto-connect
2025-10-17 16:00:01.456  INFO --- AlgoLabWebSocketClient  : ✅ WebSocket connected
2025-10-17 16:00:01.567  INFO --- AlgoLabWebSocketClient  : ✅ IMMEDIATE subscription sent: [USDTRY]
2025-10-17 16:00:02.678  INFO --- AlgoLabWebSocketClient  : ✅ Received TICK data: Symbol=USDTRY, Price=34.1234
```

Bu sırayı görüyorsanız her şey çalışıyor demektir! 🎉

---

**Oluşturulma:** 2025-10-17
**Güncelleme:** Auto-generated by Claude Code
